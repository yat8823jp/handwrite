const l=document.getElementById("imageCanvas"),n=document.getElementById("drawCanvas"),m=document.getElementById("drawTempCanvas"),d=document.getElementById("pointerCanvas");let c=1,u;const k="#333",S=10,s=[],i=[],D=document.getElementById("undoMark"),y=document.getElementById("redoMark"),b=document.getElementById("clearMark"),B=document.getElementById("downloadMark"),Y=document.getElementById("brush-size-range"),h=document.getElementById("download"),C=document.getElementById("clear"),R=document.getElementById("clear-modal");document.getElementById("clearCancel");const P=document.getElementById("clearConfirm");document.getElementById("clear-modal-form");const w=document.getElementById("undo"),x=document.getElementById("redo");C.disabled=!0;w.disabled=!0;x.disabled=!0;const t={imageCtx:l.getContext("2d"),drawCtx:n.getContext("2d",{willReadFrequently:!0}),drawTempCtx:m.getContext("2d"),pointerCtx:d.getContext("2d")};let a={holdClick:!1,brushSize:4,strokeColor:"rgba(0, 0, 0, 1)",startX:0,startY:0},W=e=>{document.getElementById("brush-size").innerHTML=e,a.brushSize=e},I=()=>{let e=n.clientWidth,o=n.clientHeight;(n.width!=e||n.height!=o)&&(l.width=e,l.height=o,n.width=e,n.height=o,m.width=e,m.height=o,d.width=e,d.height=o)};l.getContext&&n.getContext&&m.getContext&&d.getContext&&(window.addEventListener("load",function(e){d.addEventListener("mousedown",L),d.addEventListener("touchstart",L),d.addEventListener("mousemove",T),d.addEventListener("touchmove",H),d.addEventListener("mouseup",p),d.addEventListener("touchend",o=>{o.preventDefault()}),d.addEventListener("mouseout",o=>{t.pointerCtx.clearRect(0,0,l.width,l.height),a.holdClick&&p(o)}),I()}),window.addEventListener("resize",I()),window.addEventListener("change",()=>{c=Number(document.querySelector('input[name="mode"]:checked').value)}),Y.addEventListener("change",e=>{W(e.target.value)}),w.addEventListener("click",()=>q()),x.addEventListener("click",()=>F()),C.addEventListener("click",()=>J()),h.addEventListener("click",e=>j(e)));let L=e=>{let o=f(e);a.holdClick=!0,a.startX=o.x,a.startY=o.y,U(),v()},f=e=>{const o=e.target.getBoundingClientRect();let r={x:0,y:0};return e.touches?(r.x=Math.floor(e.touches[0].clientX-o.left),r.y=Math.floor(e.touches[0].clientY-o.top)):(r.x=e.offsetX,r.y=e.offsetY),r},H=e=>{if(e.touches.length<=1)T(e);else if(e.touches.length>=2)return},T=e=>{M(e),e.preventDefault(),c===1?a.holdClick&&z(e):c===2&&(M(e),a.holdClick&&X(e))},p=e=>{a.holdClick=!1,c===1?z(e):c===2&&X(e)},z=e=>{let o=f(e);t.drawCtx.lineWidth=a.brushSize,t.drawCtx.strokeStyle=a.strokeColor,t.drawCtx.lineJoin="round",t.drawCtx.lineCap="round",t.drawCtx.globalCompositeOperation="source-over",t.drawCtx.beginPath(),t.drawCtx.moveTo(a.startX,a.startY),t.drawCtx.lineTo(o.x,o.y),t.drawCtx.stroke(),t.drawCtx.closePath(),a.startX=o.x,a.startY=o.y,g()},X=e=>{let o=f(e);t.drawCtx.lineWidth=a.brushSize,t.drawCtx.strokeStyle="rgba( 255, 255, 255, 1 )",t.drawCtx.globalCompositeOperation="destination-out",t.drawCtx.beginPath(),t.drawCtx.moveTo(a.startX,a.startY),t.drawCtx.lineTo(o.x,o.y),t.drawCtx.stroke(),t.drawCtx.closePath(),a.startX=o.x,a.startY=o.y},M=e=>{let o=f(e);t.pointerCtx.clearRect(0,0,l.width,l.height),c===2?t.pointerCtx.strokeStyle="rgba( 221, 221, 221, 1 )":t.pointerCtx.strokeStyle=a.strokeColor,t.pointerCtx.lineWidth=a.brushSize,t.pointerCtx.lineCap="round",t.pointerCtx.beginPath(),t.pointerCtx.moveTo(o.x,o.y),t.pointerCtx.lineTo(o.x,o.y),t.pointerCtx.stroke(),t.pointerCtx.closePath()},v=()=>{u=t.drawCtx.getImageData(0,0,n.width,n.height),s.length>=S&&s.shift(),s.push(u),w.disabled=!1,D.style.color="#333"},O=()=>{u=t.drawCtx.getImageData(0,0,n.width,n.height),i.length>=S&&i.shift(),i.push(u),x.disabled=!1,y.style.color="#333"},q=()=>{s.length>0&&(O(),t.drawCtx.putImageData(s.pop(),0,0),s.length||(w.disabled=!0,D.style.color=null)),g()},F=()=>{i.length>0&&(v(),t.drawCtx.putImageData(i.pop(),0,0),i.length||(x.disabled=!0,y.style.color=null)),g()},U=()=>{i.length=0,y.style.color=null},g=()=>(u=t.drawCtx.getImageData(0,0,n.width,n.height),data=u.data,dataReduce=data.reduce(function(e,o,r,E){return e+o}),dataReduce?(C.disabled=!1,b.style.color=k,h.disabled=!1,B.style.color=k,!1):(C.disabled=!0,b.style.color=null,h.disabled=!0,B.style.color=null,!0)),J=()=>{R.showModal(),P.addEventListener("click",N)},N=()=>{v(),t.imageCtx.clearRect(0,0,l.width,l.height),t.drawCtx.clearRect(0,0,n.width,n.height),t.pointerCtx.clearRect(0,0,n.width,n.height),g(),R.close()},j=e=>{if(g())e.preventDefault();else{let r=Math.floor(new Date().getTime()/1e3),E=n.toDataURL("image/png");h.download=r,h.href=E}};
